---
title: "REM"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{REM}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=6, fig.height=4
)
```

```{r setup}
library(REM)
library(GPArotation)
```

# Introduction
This vignette introduces the use of the robust expectation maximization (REM) algorithm; a statistical method for estimating the parameters of a latent variable model in the presence of population heterogeneity as suggested by [Nieser & Cochran (2023)](https://psycnet.apa.org/doi/10.1037/met0000413). The REM algorithm is based on the expectation-maximization (EM) algorithm, but it allows for the case when not all the data are generated by the assumed data generating model. 

# Data Description 
To illustrate the practical application of the REM (Robust Expectation Maximization) package for both Exploratory and Confirmatory Factor Analysis, we have chosen to employ it in the context of the Mental Health - Depression Screener (DPQ_J) dataset obtained from the National Health and Nutrition Examination Survey (NHANES). This data set is publicly accessible via the following link: [NHANES DPQ_J Dataset](https://wwwn.cdc.gov/nchs/nhanes/search/datapage.aspx?Component=Questionnaire&CycleBeginYear=2017).

The DPQ_J dataset consists of responses from participants aged 12 years and older who completed a nine-item depression screening instrument known as the Patient Health Questionnaire (PHQ-9) (Kroenke and Spitzer, 2002; Kroenke et al., 2001). This instrument assesses the frequency of depression symptoms experienced over the preceding two weeks and assigns scores ranging from 0 to 3, where these scores correspond to the following categories: "not at all," "several days," "more than half the days," and "nearly every day," respectively. The individual item responses are represented by variables DPQ010 through DPQ100, with SEQN denoting the respondent's unique sequence number.

It is important to note that responses of 7 and 9 in this data set are indicative of refusals or "don't know" responses and are consequently treated as missing values in the analysis. Furthermore, our analysis exclusively includes data from participants aged 18 and over, as indicated in the provided data set.

For additional details regarding this data set, please refer to the following link: [NHANES DPQ_J Dataset Details](https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/DPQ_J.htm).

```{r}
library('foreign')
PHQ.df <- read.xport("/Users/bryanortiz/Library/CloudStorage/OneDrive-UW-Madison/Research/REM/DPQ_J.XPT")
```

# Preprocessing 

The REM package necessitates data in a matrix format and the selection of variables relevant to the required scores for factor analysis. In the context of the chosen data set, it's important to note that SEQN is unnecessary for the analysis, and DPQ100 has been excluded from the analytical process. Additionally, responses marked as 7 and 9, signifying refusals or "don't know" responses, are treated as missing values within the data set.

```{r}
data = PHQ.df[,c(-1,-11)] #eliminating first and last column
data[data == 7] <- NA
data[data == 9] <- NA
data = na.omit(data) #remove rows with NA's
```


## Splitting the dataset

The data was divided into two distinct datasets through a sampling method that ensured no duplication. One of these datasets was utilized for exploratory factor analysis, while the other was employed for confirmatory factor analysis.


```{r}
set.seed(1234)
random <- sort(sample(1:nrow(data),size = nrow(data)/2,replace = FALSE))

data_EFA <- data[random,]
data_CFA <- data[-random,]
```


# Modeling using REM for Exploratory Factor Analysis

The REM_EFA function, specifically designed for conducting exploratory factor analysis, necessitates data to be structured in matrix form, along with the specification of two crucial parameters: k_range and delta. The k_range parameter comprises a vector that defines the range of factors to be modeled. In the example provided, the algorithm conducts exploratory analysis for 2, 3, and 4 factors. Moreover, the delta parameter serves as a critical hyper-parameter, ranging from 0 to 1, and it reflects the researcher's tolerance level for potentially down-weighting data inaccurately within the model, and therefore allowing for heterogeneity.

The output of this model is organized into three distinct lists, each corresponding to the number of factors under consideration, thereby facilitating a comprehensive exploration of factor structures.

Consider the sample of the PHQ data set intended for the exploratory analysis. Here we chose to model 1 to three factors with a delta = 0.05. 

```{r}
start <- Sys.time()

model_EFA = REM_EFA( X = data_EFA, k_range = 1:3, delta = 0.05,ctrREM = controlREM(maxiter = 1e4,min_weights = 1e-20, max_ueps =  0.3,steps = 10))

print( Sys.time() - start )

```


Probably eliminate this part
```{r}
start <- Sys.time()
model_EFA2 = REM_EFA( X = data_EFA, k_range = 1:3, delta = 0.0,ctrREM = controlREM(maxiter = 1e4,min_weights = 1e-20, max_ueps =  0.3,steps = 10))

print( Sys.time() - start )
```


# The summary function

The summary function selects the optimal model using the lowest score of Bayesian Information Criterion (BIC) from the number of factors considered. In this case, it selects the optimal model after considering the BIC in the models with 1, 2, and 3 factors.

```{r}
summary(model_EFA)
```

## Plot Distribution of the weights

We want to know what is the distribution of the weights to know how much people are getting down-weighted.

```{r}

hist(model_EFA[[2]]$REM_output$weights,main="REM Weight Distribution",xlab = "Weights", ylab = "Frequency")
```
# Confirmatory Factor Analysis

To conduct a confirmatory factor analysis, several parameters need to be defined, including X (the numeric data frame under consideration), delta (a crucial hyper-parameter), and the model which consists of structural equations relating the measured variables with the latent variables. This model parameter converts the structural equations into a $p \times k$ matrix, where 'p' is determined by the number of variables in the data set, and 'k' represents the number of factors being modeled.

Consider the following example. Based on our earlier analysis, it has been determined that the model with the lowest BIC is the one that contains two factors. As a result, we will employ the REM_CFA function to conduct a confirmatory factor analysis with two factors (k = 2). For simplicity, the model  will establish the following relationships between the variables and the factors: 

$$Somatic = DPQ010 + DPQ020 + DPQ060 + DPQ090$$
$$Cognitive/Affective = DPQ030 + DPQ040 + DPQ050 + DPQ070 + DPQ080$$

In the provided structural equation model, two latent variables, "Cognitive" and "Somatic," are being defined and regressed on a set of observed variables. To create the model parameter, first create a string variable that contains each equation in a new line.

```{r}
# Define your model as a string
model <- " Cognitive ~ DPQ010 + DPQ020 + DPQ060 + DPQ090  
          Somatic ~ DPQ030 + DPQ040 + DPQ050 + DPQ070 + DPQ080
"
```

The model can be explained as follows:

1. Latent Variables:
   - "Cognitive" and "Somatic" are the two latent variables in the model. Latent variables are not directly observed but are inferred from a set of observed variables (indicators) based on their relationships.

2. Indicators:
   - For the "Cognitive" latent variable, it is regressed on the following observed variables (indicators): DPQ010, DPQ020, DPQ060, and DPQ090. These observed variables are assumed to be related to the underlying cognitive construct.

   - For the "Somatic" latent variable, it is regressed on the observed variables DPQ030, DPQ040, DPQ050, DPQ070, and DPQ080. These observed variables are assumed to be related to the underlying somatic construct.

3. Regression Relationships:
   - The "~" symbol indicates a regression relationship. For example, "Cognitive ~ DPQ010 + DPQ020 + DPQ060 + DPQ090 " implies that the latent variable "Cognitive" is regressed on the observed variables DPQ010, DPQ020, DPQ060, and DPQ090. 

4. Interpretation:
   - This model is used to investigate the relationships between the latent variables "Cognitive" and "Somatic" and their respective sets of observed variables. It examines how well the observed variables predict the underlying cognitive and somatic constructs. The model will estimate coefficients for these relationships, providing information about the strength and direction of these associations.


```{r}
# CFA model with delta = 0.05
model_CFA2 = REM_CFA(X = data_CFA,delta = 0.05,model = model,ctrREM = controlREM(steps = 10,max_ueps = 0.1,min_weights = 1e-5))
```

```{r}
summary(model_CFA2)
```

Trying to replicate the example from lavaan with delta = 0 and with delta = 0.05. Compare to cfa in lavaan. Explain the cons matrix from the lavaan vignette.

# Comparing REM and Lavaan outputs

As previously stated, the delta parameter in the robust expectation maximization algorithm could be interpreted as the level of flexibility allowed to capture population heterogeneity. Setting the delta parameter equal to zero, however, would model a latent variable model using same estimates as the ones found in the lavaan package. 

To compare the robust expectation maximization algorithm with the well-known latent variable model (lavaan) package one needs needs to model the REM algorithm with delta = 0.

```{r}
# REM CFA with delta = 0
model_CFA_REM = REM_CFA(X = data_CFA, delta = 0.0,model = model,ctrREM = controlREM(steps = 10, max_ueps = 0.1,min_weights = 1e-20))

model_CFA_REM$REM_output$lambda
```

```{r}
# Lavan CFA Model

library(lavaan)

SEM_lavaan = '
          Affective =~ DPQ010+ DPQ020 + DPQ060 + DPQ090  
          Somatic =~ DPQ030 + DPQ040 + DPQ050 + DPQ070 + DPQ080
'

model_lavaan <- cfa(SEM_lavaan, data = data)
summary(model_lavaan, standardized = T)$pe[,c("lhs", "op", "rhs", "std.all")]
g = summary(model_lavaan, standardized=T)
g$pe[,c("lhs","op","rhs","std.all")]

```

