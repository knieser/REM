---
title: "REM"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{REM}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=6, fig.height=4
)
```

```{r setup}
library(REM)
library(GPArotation)
```

# Introduction
This vignette introduces the use of the robust expectation maximization (REM) algorithm; a statistical method for estimating the parameters of a latent variable model in the presence of population heterogeneity as suggested by [Nieser & Cochran (2023)](https://psycnet.apa.org/doi/10.1037/met0000413). The REM algorithm is based on the expectation-maximization (EM) algorithm, but it allows for the case when not all the data are generated by the assumed data generating model. 

# Data Description 
To illustrate the practical application of the REM (Robust Expectation Maximization) package for both Exploratory and Confirmatory Factor Analysis, we have chosen to employ it in the context of the Holzinger and Swineford dataset publicly available in the lavaan package. 

The Holzinger and Swineford dataset consist of mental ability test scores of seventh and eighth grade children from two different schools. Originally, this
dataset consisted of 26 test scores but this modified version in the lavaan package consist of 15 variables, 9 of which are test scores.

- __Covariates__
    - `id`: student's Identification number.
    - `sex`: Gender (1 = male, 2 = female).
    - `ageyr`: Age year part.
    - `agemo`: Age month part.
    - `school`: Shool (Pasteur or Grant-White).
    - `grade`: Grade (7 = 7th grade, 8 = eighth grade).
    - `x1`: Visual perception.
    - `x2`: Cubes.
    - `x3`: Lozenges.
    - `x4`: Paragraph comprehension.
    - `x5`: Sentence completion.
    - `x6`: Word meaning.
    - `x7`: Speeded addition.
    - `x8`: Speeded counting of dots.
    - `x9`: Speeded discrimination straight and curved capitals.


```{r}
library(lavaan)

df <- HolzingerSwineford1939
head(df)
```

# Preprocessing 

The REM package necessitates data in a matrix format and the selection of variables relevant to the required scores for factor analysis. In the context of the Holzinger data set, it's important to note that only scores will be used in the analysis and therefore, all covariates outside of the test variables were eliminated.

```{r}
data = df[,-c(1:6)] 
```


# Modeling using REM for Exploratory Factor Analysis

The REM_EFA function, specifically designed for conducting exploratory factor analysis, necessitates data to be structured in matrix form, along with the specification of two crucial parameters: k_range and delta. The k_range parameter comprises a vector that defines the range of factors to be modeled. In the example provided, the algorithm conducts exploratory analysis for 2, 3, and 4 factors. Moreover, the delta parameter serves as a critical hyper-parameter, ranging from 0 to 1, and it reflects the researcher's tolerance level for potentially down-weighting data inaccurately within the model, and therefore allowing for heterogeneity.

The output of this model is organized into three distinct lists, each corresponding to the number of factors under consideration, thereby facilitating a comprehensive exploration of factor structures.

Here we chose to perform an exploratory factor analysis model with  one to three factors with a delta = 0.05. 

```{r}
model_EFA = REM_EFA( X = data, k_range = 1:3, delta = 0.05)
```


# The summary function

The summary function selects the optimal model using the lowest score of Bayesian Information Criterion (BIC) from the number of factors considered. In other words, it selects the optimal model after considering the BIC in the models with 1, 2, and 3 factors.

```{r}
summary(model_EFA)
```

From the REM and EM output above, note that $x_4$, $x_5$, and $x_6$ are strongly correlated with Factor 1. Similarly, $x1_$,$x_2$, and $x_3$ are moderately correlated with factor 2 and that $x_7$, $x_8$ and $x_9$ are moderately correlated with Factor 3. Additionally, the gamma or average REM weight was 0.849. 


## Plot Distribution of the weights

We want to know what is the distribution of the weights to know how much people are getting down-weighted.

```{r}

hist(model_EFA[[2]]$REM_output$weights,main="REM Weight Distribution",xlab = "Weights", ylab = "Frequency")
```
# Confirmatory Factor Analysis

To conduct a confirmatory factor analysis, several parameters need to be defined, including X (the numeric data frame under consideration), delta (a crucial hyper-parameter), and the model which consists of structural equations relating the measured variables with the latent variables. This model parameter converts the structural equations into a $p \times k$ matrix, where 'p' is determined by the number of variables in the data set, and 'k' represents the number of factors being modeled.

Consider the following example. Based on our earlier analysis, it has been determined that the model with the lowest BIC is the one that contains two factors. As a result, we will employ the REM_CFA function to conduct a confirmatory factor analysis with three factors (k = 3). For simplicity, the model  will establish the following relationships between the variables and the factors: 

$$Visual = x1 + x2 + x3 $$
$$Textual = x4 + x5 + x6 $$
$$Speed = x7 + x8 + x9$$
In the provided structural equation model, three latent variables, "$Visual$","$Textual$", and "$Speed$", are being defined and on a set of observed variables. To create the model parameter, first create a string variable that contains each equation in a new line and separate equalities using the $~$ symbol as shown below. 

```{r}
# Define your model as a string
model <- " visual ~ x1  +  x2  +  x3 
          Textual ~ x4 + x5 + x6
          Speed ~ x7 + x8 + x9
"
```


This model is used to investigate the relationships between the latent variables "visual","textual", and "speed" and their respective sets of observed variables by examining how well the observed variables predict the underlying constructs. The model will estimate coefficients for these relationships, providing information about the strength and direction of these associations.


```{r}
# CFA model with delta = 0.05
model_CFA = REM_CFA(X = data,delta = 0.05,model = model)
```

```{r}
summary(model_CFA)
```
The output above depicts estimate for the confirmatory analysis. Note that again  $x_4$, $x_5$, and $x_6$ are strongly correlated with Factor 1. Similarly, $x1_$,$x_2$, and $x_3$ are moderately correlated with factor 2 and that $x_7$, $x_8$ and $x_9$ are moderately correlated with Factor 3. However, the gamma or average REM weight was 0.831.

